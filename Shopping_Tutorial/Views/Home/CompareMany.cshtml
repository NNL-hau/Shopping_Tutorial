@model Shopping_Tutorial.Models.ViewModels.CompareManyViewModel
@{
    Layout = null;
    ViewData["Title"] = "So s√°nh s·∫£n ph·∫©m";
    var count = Model.Products?.Count ?? 0;
}

<div id="chat-popup" style="display: flex; flex-direction: column;
    width: 100%; height: 100%; background-color: #FFF;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    margin: 40px auto 0 auto;">

    <!-- Header -->
    <div id="chat-header" style="background: linear-gradient(90deg, #fbc2eb, #a6c1ee); color: white; padding: 10px; text-align: center;">
        <h4>H·ªó tr·ª£ ch·ªçn s·∫£n ph·∫©m </h4>
    </div>

    <!-- Tin nh·∫Øn + s·∫£n ph·∫©m -->
    <div id="chat-messages" style="padding: 10px; flex-grow: 1; overflow-y: auto;">
        <div class="message">
            <div class="message-container">
                <img src="/images/6.jpg" alt="Bot" class="profile-image" />
                <div class="bot-message">Xin ch√†o! D∆∞·ªõi ƒë√¢y l√† c√°c s·∫£n ph·∫©m m√† b·∫°n ƒëang mu·ªën so s√°nh ? H√£y chat v·ªõi t√¥i ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ l·ª±a ch·ªçn nh√© !</div>
            </div>
        </div>

        <!-- S·∫£n ph·∫©m n·∫±m trong chat -->
        <div class="bot-message" style="display: flex; flex-wrap: wrap; gap: 12px; background: transparent; box-shadow: none;">
            @foreach (var p in Model.Products)
            {
                <div class="product-card">
                    <img src="~/images/@p.Image" alt="@p.Name" />
                    <div class="info">
                        <strong>@p.Name</strong>
                        <div>Gi√°: @p.Price.ToString("#,##0") VNƒê</div>
                        <div>Th∆∞∆°ng hi·ªáu: @p.Brand?.Name</div>
                        <div>Danh m·ª•c: @p.Category?.Name</div>
                        <div>Danh m·ª•c: @Html.Raw(p.Description)</div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- C√¢u h·ªèi nhanh -->
    <div id="chat-quick-questions" style="padding: 6px 10px; background: transparent; border-top: none; display: block; max-height: 150px; overflow-y: auto;">
        <button type="button" class="quick-question" data-question="So s√°nh ram c√°c s·∫£n ph·∫©m m√¨nh ch·ªçn gi√∫p m√¨nh">So s√°nh Ram</button>
        <button type="button" class="quick-question" data-question="Th√¥ng s·ªë c√°c s·∫£n ph·∫©m m√¨nh ch·ªçn c√≥ g√¨ kh√°c bi·ªát">So s√°nh th√¥ng s·ªë</button>
        <button type="button" class="quick-question" data-question="s·∫£n ph·∫©m n√†o m√¨nh ch·ªçn c√≥ ch·∫ø ƒë·ªô b·∫£o h√†nh t·ªët h∆°n n·∫øu h·ªèng">So s√°nh b·∫£o h√†nh</button>
        <button type="button" class="quick-question" data-question="s·∫£n ph·∫©m n√†o m√¨nh ch·ªçn c√≥ th·ªÉ h·ªó tr·ª£ ch∆°i game v√† ƒë·ªì ho·∫°">So s√°nh ch∆°i game v√† ƒë·ªì ho·∫°</button>
        <button type="button" class="quick-question" data-question="S·∫£n ph·∫©m n√†o m√¨nh ch·ªçn gi√° ph√π h·ª£p m√† ch·∫°y ·ªïn v·ªõi ng∆∞·ªùi ƒëi h·ªçc ho·∫∑c vƒÉn ph√≤ng">
            S√°nh gi√° s·∫£n ph·∫©m n√†o m√¨nh ch·ªçn c√°i n√†o ph√π h·ª£p v·ªõi c√¥ng vi·ªác vƒÉn ph√≤ng v√† h·ªçc
        </button>
        
    </div>
    <!-- Input -->
    <div   id="chat-input" style="padding: 10px; background-color: #f8f9fa; display: flex;">
        <input type="text" id="user-input" style="flex: 1; padding: 5px;" placeholder="Nh·∫≠p tin nh·∫Øn..." />
        <button id="send-button" style="margin-left: 5px; border-radius: 5%; padding: 5px; color: white; background: linear-gradient(90deg, #fbc2eb, #a6c1ee); border: none;">G·ª≠i</button>
    </div>
</div>

<style>
    /* Tin nh·∫Øn ng∆∞·ªùi d√πng */
    .user-message {
        background-color: #3366FF;
        color: white;
        padding: 8px 12px;
        border-radius: 10px;
        max-width: 70%;
        word-wrap: break-word;
        margin: 6px 0 6px auto;
        display: inline-block;
    }

    /* Tin nh·∫Øn bot */
    .bot-message {
        background-color: #f1f1f1;
        color: black;
        padding: 8px 12px;
        border-radius: 10px;
        max-width: 100%;
        word-wrap: break-word;
        margin: 6px auto 6px 0;
        display: inline-block;
    }

    /* Card s·∫£n ph·∫©m trong chat */
    .product-card {
        flex: 1 1 calc(33.33% - 12px);
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        min-width: 180px;
        max-width: 220px;
    }

        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
        }

        .product-card .info {
            margin-top: 8px;
            font-size: 14px;
            text-align: center;
        }

    .profile-image {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .message-container {
        display: flex;
        align-items: flex-start;
    }

    /* N√∫t c√¢u h·ªèi nhanh */
    #chat-quick-questions .quick-question {
        background: #f2f2f2; /* n·ªÅn x√°m nh·∫°t */
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 12px;
        cursor: pointer;
        color: #333;
        display: block;
        width: 100%;
        text-align: left;
        margin-bottom: 6px;
        opacity: 0.85; /* m·∫∑c ƒë·ªãnh h∆°i m·ªù */
        transition: opacity 0.2s ease, background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    #chat-quick-questions .quick-question:hover {
        background: #e0e0e0; /* x√°m h∆°n khi hover */
        color: #0066FF;
        border-color: #cfe3ff;
        opacity: 0.7; /* m·ªù ƒëi khi hover */
    }
</style>

<script>
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');

    async function handleUserInput() {
        const userMessage = userInput.value.trim();

        if (userMessage) {
            addMessage(userMessage, true);
            userInput.value = '';

            sendButton.disabled = true;
            userInput.disabled = true;

            try {
                const response = await fetch('/Chat/GetResponseCompare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: userMessage })
                });

                if (!response.ok) {
                    throw new Error('Failed to get response');
                }

                const data = await response.json();
                addMessage(data.response, false);
            } catch (error) {
                console.error('Error:', error);
                addMessage('Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.', false);
            } finally {
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }
    }

    function addMessage(message, isUser) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');

        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');

        const profileImage = document.createElement('img');
        profileImage.classList.add('profile-image');
        profileImage.src = isUser ? '/images/user.jpg' : '/images/6.jpg';
        profileImage.alt = isUser ? 'User' : 'Bot';

        const messageContent = document.createElement('div');
        messageContent.classList.add(isUser ? 'user-message' : 'bot-message');

        let formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formattedMessage = formattedMessage.replace(/\n/g, '<br/>');
        formattedMessage = formattedMessage.replace(/^- (.*)/gm, '<li>$1</li>');


        messageContent.innerHTML = formattedMessage; // S·ª≠ d·ª•ng innerHTML ƒë·ªÉ hi·ªÉn th·ªã HTML

        messageContainer.appendChild(profileImage);
        messageContainer.appendChild(messageContent);
        messageElement.appendChild(messageContainer);

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    sendButton.addEventListener('click', handleUserInput);

    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleUserInput();
        }
    });

    // Hi·ªÉn th·ªã/ƒë√≥ng c·ª≠a s·ªï chat (ch·ªâ ch·∫°y n·∫øu c√≥ c√°c ph·∫ßn t·ª≠ n√†y tr√™n trang)
    var chatOpenBtn = document.getElementById('chat-widget-button');
    if (chatOpenBtn) {
        chatOpenBtn.addEventListener('click', function () {
            document.getElementById('chat-popup').style.display = 'block';
        });
    }

    var chatCloseBtn = document.getElementById('close-chat');
    if (chatCloseBtn) {
        chatCloseBtn.addEventListener('click', function () {
            document.getElementById('chat-popup').style.display = 'none';
        });
    }

    // Ch·ªâ g·∫Øn s·ª± ki·ªán scroll n·∫øu c√≥ jQuery (trang n√†y Layout = null n√™n c√≥ th·ªÉ kh√¥ng c√≥)
    if (window.jQuery) {
        $(window).on("scroll", function () {
            if ($(window).scrollTop() > 100) {
                $(".header-bottom").addClass("sticky-header");
            } else {
                $(".header-bottom").removeClass("sticky-header");
            }
        });
    }

    // G√°n s·ª± ki·ªán cho c√°c n√∫t c√¢u h·ªèi nhanh v√† ·∫©n sau l·∫ßn b·∫•m ƒë·∫ßu ti√™n
    // G√°n s·ª± ki·ªán c√¢u h·ªèi nhanh khi DOM ƒë√£ s·∫µn s√†ng
    (function attachQuickQuestionHandlers() {
        var container = document.getElementById('chat-quick-questions');
        if (!container) return;
        var quickHidden = false;
        container.querySelectorAll('.quick-question').forEach(function (btn) {
            btn.addEventListener('click', function () {
                var q = this.getAttribute('data-question');
                if (!q) return;
                userInput.value = q;
                handleUserInput();
                if (!quickHidden) {
                    container.style.display = 'none';
                    quickHidden = true;
                }
            });
        });
    })();
</script>

<!-- Configurator Section - Sau ph·∫ßn so s√°nh s·∫£n ph·∫©m -->
<div class="configurator-section" style="margin-top: 40px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
    <h2 style="color: #3399FF; margin-bottom: 30px; text-align: center;">
        <i class="fa fa-cog"></i> üîß T√πy ch·ªânh s·∫£n ph·∫©m
    </h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
        @foreach (var product in Model.Products)
        {
            <div class="product-configurator" data-product-id="@product.Id" style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 20px; background: #f9f9f9;">
                <h3 style="color: #3399FF; margin-top: 0;">@product.Name</h3>
                <img src="~/images/@product.Image" alt="@product.Name" style="width: 100%; max-height: 200px; object-fit: contain; margin: 15px 0; border-radius: 8px;" />
                
                <!-- M√†u s·∫Øc -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2277cc; margin-bottom: 10px;">M√†u s·∫Øc:</h4>
                    <div class="color-options" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div class="color-option selected" style="width: 40px; height: 40px; border-radius: 50%; background: #3498db; cursor: pointer; border: 3px solid #3399FF; box-shadow: 0 0 10px rgba(51, 153, 255, 0.5);" 
                             data-color="#3498db" onclick="changeProductColor(@product.Id, '#3498db', this)"></div>
                        <div class="color-option" style="width: 40px; height: 40px; border-radius: 50%; background: #e74c3c; cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" 
                             data-color="#e74c3c" onclick="changeProductColor(@product.Id, '#e74c3c', this)"></div>
                        <div class="color-option" style="width: 40px; height: 40px; border-radius: 50%; background: #2ecc71; cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" 
                             data-color="#2ecc71" onclick="changeProductColor(@product.Id, '#2ecc71', this)"></div>
                        <div class="color-option" style="width: 40px; height: 40px; border-radius: 50%; background: #f39c12; cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" 
                             data-color="#f39c12" onclick="changeProductColor(@product.Id, '#f39c12', this)"></div>
                        <div class="color-option" style="width: 40px; height: 40px; border-radius: 50%; background: #9b59b6; cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" 
                             data-color="#9b59b6" onclick="changeProductColor(@product.Id, '#9b59b6', this)"></div>
                        <div class="color-option" style="width: 40px; height: 40px; border-radius: 50%; background: #34495e; cursor: pointer; border: 3px solid transparent; transition: all 0.3s;" 
                             data-color="#34495e" onclick="changeProductColor(@product.Id, '#34495e', this)"></div>
                    </div>
                </div>

                <!-- V·∫≠t li·ªáu -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2277cc; margin-bottom: 10px;">V·∫≠t li·ªáu:</h4>
                    <select class="material-select form-control" onchange="changeProductMaterial(@product.Id, this.value)" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="standard">Ti√™u chu·∫©n</option>
                        <option value="metal">Kim lo·∫°i</option>
                        <option value="glass">Th·ªßy tinh</option>
                        <option value="plastic">Nh·ª±a</option>
                        <option value="wood">G·ªó</option>
                        <option value="carbon">Carbon Fiber</option>
                    </select>
                </div>

                <!-- Linh ki·ªán -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2277cc; margin-bottom: 10px;">Linh ki·ªán:</h4>
                    <div class="components-list">
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="checkbox" checked onchange="toggleProductComponent(@product.Id, 'screen', this.checked)"> 
                            <span>M√†n h√¨nh</span>
                        </label>
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="checkbox" checked onchange="toggleProductComponent(@product.Id, 'keyboard', this.checked)"> 
                            <span>B√†n ph√≠m</span>
                        </label>
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="checkbox" checked onchange="toggleProductComponent(@product.Id, 'battery', this.checked)"> 
                            <span>Pin</span>
                        </label>
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="checkbox" checked onchange="toggleProductComponent(@product.Id, 'camera', this.checked)"> 
                            <span>Camera</span>
                        </label>
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="checkbox" checked onchange="toggleProductComponent(@product.Id, 'speaker', this.checked)"> 
                            <span>Loa</span>
                        </label>
                    </div>
                </div>

                <!-- N√∫t xem 3D v√† th√™m v√†o gi·ªè h√†ng -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <a href="@Url.Action("View3D", "Product", new { id = product.Id })" 
                       class="btn btn-default" 
                       style="flex: 1; background: linear-gradient(90deg, #fbc2eb, #a6c1ee); color: white; border: none; padding: 10px; border-radius: 5px; text-align: center; text-decoration: none;">
                        <i class="fa fa-cube"></i> Xem 3D
                    </a>
                    <button onclick="addToCartFromConfigurator(@product.Id)" 
                            class="btn btn-default" 
                            style="flex: 1; background: linear-gradient(90deg, #fbc2eb, #a6c1ee); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                        <i class="fa fa-shopping-cart"></i> Th√™m v√†o gi·ªè
                    </button>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .color-option:hover {
        transform: scale(1.1);
        border-color: #3399FF !important;
    }

    .product-configurator {
        transition: all 0.3s ease;
    }

    .product-configurator:hover {
        box-shadow: 0 4px 12px rgba(51, 153, 255, 0.2);
        transform: translateY(-5px);
    }
</style>

<script>
    // Store configuration for each product
    const productConfigs = {};

    @foreach (var product in Model.Products)
    {
        <text>
        productConfigs[@product.Id] = {
            color: '#3498db',
            material: 'standard',
            components: {
                screen: true,
                keyboard: true,
                battery: true,
                camera: true,
                speaker: true
            }
        };
        </text>
    }

    function changeProductColor(productId, color, element) {
        productConfigs[productId].color = color;
        
        // Update UI
        const configurator = element.closest('.product-configurator');
        configurator.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.remove('selected');
            opt.style.border = '3px solid transparent';
            opt.style.boxShadow = 'none';
        });
        
        element.classList.add('selected');
        element.style.border = '3px solid #3399FF';
        element.style.boxShadow = '0 0 10px rgba(51, 153, 255, 0.5)';
        
        // Visual feedback
        const productImg = configurator.querySelector('img');
        productImg.style.filter = `hue-rotate(${getHueRotation(color)}deg)`;
        
        console.log(`Product ${productId} color changed to ${color}`);
    }

    function changeProductMaterial(productId, material) {
        productConfigs[productId].material = material;
        console.log(`Product ${productId} material changed to ${material}`);
        
        // Show notification
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'success',
                title: 'V·∫≠t li·ªáu ƒë√£ thay ƒë·ªïi',
                text: `V·∫≠t li·ªáu: ${getMaterialName(material)}`,
                timer: 2000,
                showConfirmButton: false
            });
        }
    }

    function toggleProductComponent(productId, component, enabled) {
        productConfigs[productId].components[component] = enabled;
        console.log(`Product ${productId} component ${component} ${enabled ? 'enabled' : 'disabled'}`);
    }

    function addToCartFromConfigurator(productId) {
        const config = productConfigs[productId];
        
        // Add product to cart with configuration
        $.ajax({
            type: "POST",
            url: "@Url.Action("Add", "Cart")",
            data: { Id: productId },
            success: function (result) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'success',
                        title: 'ƒê√£ th√™m v√†o gi·ªè h√†ng!',
                        text: `S·∫£n ph·∫©m v·ªõi c·∫•u h√¨nh: M√†u ${config.color}, V·∫≠t li·ªáu ${getMaterialName(config.material)}`,
                        timer: 3000
                    });
                }
            },
            error: function (xhr, status, error) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói',
                        text: 'C√≥ l·ªói x·∫£y ra khi th√™m v√†o gi·ªè h√†ng.'
                    });
                }
            }
        });
    }

    function getHueRotation(color) {
        const colorMap = {
            '#3498db': 0,    // Blue
            '#e74c3c': 180,  // Red
            '#2ecc71': 120,  // Green
            '#f39c12': 30,   // Orange
            '#9b59b6': 270,  // Purple
            '#34495e': 210   // Dark blue-gray
        };
        return colorMap[color] || 0;
    }

    function getMaterialName(material) {
        const names = {
            'standard': 'Ti√™u chu·∫©n',
            'metal': 'Kim lo·∫°i',
            'glass': 'Th·ªßy tinh',
            'plastic': 'Nh·ª±a',
            'wood': 'G·ªó',
            'carbon': 'Carbon Fiber'
        };
        return names[material] || material;
    }
</script>